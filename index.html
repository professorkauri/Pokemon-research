<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Pokemon Research</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="style.css?v=2025-10-07-1" />
</head>

<body class="theme-light">
    <header>
        <div class="brand">Pokemon Research</div>

        <!-- Main view switcher -->
        <div id="mainTabs" class="segmented" role="tablist" aria-label="Main view">
            <div class="seg active" role="tab" aria-selected="true" data-view="browse">Browse All</div>
            <div class="seg" role="tab" aria-selected="false" data-view="games">Games</div>
            <div class="seg" role="tab" aria-selected="false" data-view="search">Search</div>
        </div>

        <div style="text-align:right">
            <button id="openAdmin" class="btn accent">Admin</button>
        </div>
    </header>

    <main id="main">
        <div class="placeholder">Loading data…</div>
    </main>

    <!-- Admin Overlay (unchanged controls, but updated functions are below) -->
    <div class="overlay" id="overlay" aria-hidden="true">
        <div class="admin-window" role="dialog" aria-modal="true" aria-label="Pokemon Data Admin">
            <div class="admin-header">
                <div class="admin-title">Pokemon Data Admin</div>
                <div class="segmented" id="viewTabs" role="tablist" aria-label="Admin View">
                    <div class="seg active" role="tab" aria-selected="true" data-view="pokemon">Pokemon</div>
                    <div class="seg" role="tab" aria-selected="false" data-view="games">Games</div>
                </div>
                <div class="toolbar">
                    <span class="pill" id="datasetSummary">0 Pokémon • 0 Games</span>
                    <input id="importInput" type="file" accept="application/json" style="display:none;" />
                    <button id="importBtn" class="btn" title="Import data.json">Import JSON</button>
                    <button id="downloadBtn" class="btn primary" title="Download all data as JSON">Download
                        JSON</button>
                    <button id="closeAdmin" class="btn">Close</button>
                </div>
            </div>

            <div class="admin-body">
                <div class="left-col">
                    <div class="left-header">
                        <div id="leftTitle">Pokemon</div>
                        <div class="row">
                            <button id="sortBtn" class="btn" title="Toggle sort mode">A–Z</button>
                            <button id="addBtn" class="btn" title="Add new">+</button>
                        </div>
                    </div>
                    <div class="left-search">
                        <input id="leftSearch" type="text" placeholder="Search…" />
                    </div>
                    <div id="leftList" class="list" role="listbox" aria-label="Items list"></div>
                </div>

                <div class="right-col">
                    <div class="right-header">
                        <div id="rightTitle" class="muted">No item selected</div>
                        <div class="toolbar">
                            <button id="deleteBtn" class="btn" title="Delete selected"
                                style="display:none;">Delete</button>
                        </div>
                    </div>
                    <div class="right-body" id="rightBody">
                        <div class="muted">Select or add an item to edit its details.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const s = document.createElement('link');
        s.rel = 'stylesheet';
        s.href = 'style.css?cb=' + Date.now();
        document.head.appendChild(s);

        /* =======================
           Data & Utilities
           ======================= */
        const TYPE_OPTIONS = ["", "Normal", "Fire", "Water", "Electric", "Grass", "Ice", "Fighting", "Poison", "Ground", "Flying", "Psychic", "Bug", "Rock", "Ghost", "Dragon", "Dark", "Steel", "Fairy"];
        const DEFAULT_DATA = { games: [], pokemon: [] };
        let DATA = structuredClone(DEFAULT_DATA);

        let adminActiveView = "pokemon";
        let selectedId = null;
        let leftFilter = "";
        let pokemonSortMode = "AZ"; // "AZ" | "09"
        let gameSortMode = "DATE";  // "DATE" | "AZ"

        let mainView = "browse";  // "browse" | "games" | "search"

        function safeHtml(str) { return String(str ?? "").replace(/[&<>"']/g, s => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[s])) }
        function numberOrNull(v) { const n = Number(v); return isNaN(n) ? null : n }
        function numOrNullFromInput(v) { if (v === "" || v === null || v === undefined) return null; const n = Number(v); return isNaN(n) ? null : n }
        function updateDatasetSummary() { document.getElementById("datasetSummary").textContent = `${DATA.pokemon.length} Pokémon • ${DATA.games.length} Games` }

        function byReleaseDateAsc(a, b) {
            const da = Date.parse(a.releaseDate || "1970-01-01");
            const db = Date.parse(b.releaseDate || "1970-01-01");
            return (isNaN(da) ? 0 : da) - (isNaN(db) ? 0 : db);
        }

        function debounce(fn, wait = 250) {
        let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); };
        }
        const refreshLeftList = debounce(() => renderAdminLeftList(), 250);

        function pkmnImageNameFromId(id) {
            const s = String(id ?? "").trim();
            if (/^\d+$/.test(s)) return s.padStart(4, "0");
            return s;
        }

        // ---------- image loading (memo + lazy) ----------
        const IMG_STATUS = new Map(); // url -> "ok" | "err"

        function applyBg(el, url) {
        if (!url) { el.style.backgroundImage = "none"; return; }
        el.style.backgroundImage = `url("${url}")`;
        }

        function loadBgOnce(url, onOk, onErr) {
        const status = IMG_STATUS.get(url);
        if (status === "ok") { onOk(); return; }
        if (status === "err") { onErr(); return; }
        const img = new Image();
        img.onload = () => { IMG_STATUS.set(url, "ok"); onOk(); };
        img.onerror = () => { IMG_STATUS.set(url, "err"); onErr(); };
        img.src = url; // no cache-busting here – allow browser cache
        }

        // IntersectionObserver: load when near viewport
        const lazyIO = new IntersectionObserver((entries) => {
        for (const e of entries) {
            if (!e.isIntersecting) continue;
            const el = e.target;
            lazyIO.unobserve(el);
            const url = el.dataset.bg || "";
            if (!url) return;
            loadBgOnce(
            url,
            () => applyBg(el, url),
            () => { el.style.backgroundImage = "none"; }
            );
        }
        }, { root: null, rootMargin: "300px", threshold: 0.01 });

        function lazyBg(el, url) {
        if (!url) { el.style.backgroundImage = "none"; return; }
        el.dataset.bg = url;
        // Optional: low-cost placeholder stays until loaded
        lazyIO.observe(el);
        }


        function fixJsonText(text) {
            text = text.replace(/:\s*NaN\b/g, ": null");
            try {
                const tmp = JSON.parse(text);
                if (Array.isArray(tmp)) {
                    const cleaned = tmp.filter(obj => {
                        if (obj && typeof obj === "object") {
                            return Object.values(obj).some(v => v !== null && v !== "" && v !== undefined);
                        }
                        return true;
                    });
                    return JSON.stringify(cleaned);
                }
            } catch (_) { }
            return text;
        }

        function normalizeData(json) {
            const t = (v) => String(v ?? "").trim();
            const out = { games: [], pokemon: [] };

            if (Array.isArray(json.games)) {
                out.games = json.games.map(g => ({
                    id: t(g.id ?? crypto.randomUUID()),
                    title: t(g.title),
                    releaseDate: t(g.releaseDate),
                    console: t(g.console),
                    colorHex: t(g.colorHex || "#888888"),
                    imageSlug: t(g.imageSlug)
                }));
            }

            if (Array.isArray(json.pokemon)) {
                out.pokemon = json.pokemon.map(p => {
                    // NEW: normalize pokedex into { [gameId]: { regionalDexNumber, entry } }
                    let pokedexObj = {};
                    if (Array.isArray(p.pokedex)) {
                        for (const e of p.pokedex) {
                            const gameId = String(e.version ?? e.gameId ?? "").trim();
                            if (!gameId) continue;
                            const entry = String(e.text ?? e.entry ?? "");
                            const regional = String(e.regionalDexNumber ?? e.regional ?? "").trim();
                            pokedexObj[gameId] = { regionalDexNumber: regional, entry };
                        }
                    } else if (p.pokedex && typeof p.pokedex === "object") {
                        // Also normalize any existing object-ish shapes
                        for (const [k, v] of Object.entries(p.pokedex)) {
                            const entry = String((v && (v.entry ?? v.text)) ?? "");
                            const regional = String((v && (v.regionalDexNumber ?? v.regional)) ?? "");
                            pokedexObj[String(k)] = { regionalDexNumber: regional, entry };
                        }
                    }

                    return {
                        id: String(p.id ?? p.ID ?? crypto.randomUUID()).trim(),
                        name: String(p.name ?? p.Name ?? p[" Name"] ?? "").trim(),
                        category: String(p.category ?? p.Category ?? p[" Category"] ?? "").trim(),
                        form: String(p.form ?? p.Form ?? p[" Form"] ?? "").trim(),
                        species: String(p.species ?? p.Species ?? p[" Species"] ?? "").trim(),
                        evolution: String(p.evolution ?? p.Evolution ?? "").trim(),
                        type1: String(p.type1 ?? p.Type1 ?? p[" Type1"] ?? "").trim(),
                        type2: String(p.type2 ?? p.Type2 ?? p[" Type2"] ?? "").trim(),
                        hp: numberOrNull(p.hp ?? p.HP),
                        attack: numberOrNull(p.attack ?? p.Attack),
                        defense: numberOrNull(p.defense ?? p.Defense),
                        spAtk: numberOrNull(p.spAtk ?? p["Sp Atk"] ?? p[" Sp Atk"]),
                        spDef: numberOrNull(p.spDef ?? p["Sp Def"] ?? p[" Sp Def"]),
                        speed: numberOrNull(p.speed ?? p.Speed),
                        pokedex: pokedexObj
                    };
                });
            }
            return out;
        }

async function loadInitialData() {
    try {
      const res = await fetch("./data.json"); // allow normal HTTP caching on GitHub Pages
      if (!res.ok) throw new Error("HTTP " + res.status);
      let raw = await res.text();
      let json;
      try { json = JSON.parse(raw); } catch { raw = fixJsonText(raw); json = JSON.parse(raw); }
      DATA = Array.isArray(json) ? normalizeData({ pokemon: json, games: [] }) : normalizeData(json);
    } catch (e) {
      console.warn("Could not auto-load data.json. Use Import JSON if opening via file://", e);
    }
    updateDatasetSummary();
    renderMain();
  }
  

        /* =======================
           Main Views
           ======================= */
        const mainEl = document.getElementById("main");
        const mainTabs = document.getElementById("mainTabs");
        mainTabs.addEventListener("click", (e) => {
            const seg = e.target.closest(".seg"); if (!seg) return;
            for (const s of mainTabs.querySelectorAll(".seg")) { s.classList.remove("active"); s.setAttribute("aria-selected", "false") }
            seg.classList.add("active"); seg.setAttribute("aria-selected", "true");
            mainView = seg.dataset.view; renderMain();
        });

        function renderMain() {
            if (mainView === "browse") renderBrowse();
            else if (mainView === "games") renderGames();
            else renderSearch();
        }

        // Shared ID sort (0–9 + suffix so 9, 9GM, 9M etc.)
        function parseIdForSort(raw) {
            const id = (raw || "").toString().trim();
            const m = id.match(/^(\d+)(.*)$/);
            if (m) return { num: parseInt(m[1], 10), suffix: m[2] || "" };
            return { num: Number.POSITIVE_INFINITY, suffix: id };
        }
        function idComparator(a, b) {
            const A = parseIdForSort(a.id), B = parseIdForSort(b.id);
            if (A.num !== B.num) return A.num - B.num;
            if (A.suffix === B.suffix) return 0;
            if (A.suffix === "") return -1;
            if (B.suffix === "") return 1;
            return A.suffix.localeCompare(B.suffix, undefined, { sensitivity: "base" });
        }

        function renderBrowse() {
            const list = DATA.pokemon.slice().sort(idComparator);
            const wrap = document.createElement("div");
            wrap.className = "grid";
            for (const p of list) {
                const card = document.createElement("div"); card.className = "card";
                const img = document.createElement("div"); img.className = "img";
                lazyBg(`images/pkmn/${encodeURIComponent(p.id)}.webp`);
                const title = document.createElement("div");
                title.innerHTML = `<strong>${safeHtml(p.name || "(Unnamed)")}</strong> <span class="muted">${safeHtml(p.form || "")}</span>`;
                const meta = document.createElement("div");
                meta.className = "row muted";
                meta.innerHTML = `<span class="pill">#${safeHtml(p.id)}</span><span class="pill">${safeHtml(p.type1 || "—")}${p.type2 ? " / " + safeHtml(p.type2) : ""}</span>`;
                card.appendChild(img); card.appendChild(title); card.appendChild(meta);
                wrap.appendChild(card);
            }
            mainEl.innerHTML = "";
            mainEl.appendChild(wrap);
        }

        function renderGames() {
            const list = DATA.games.slice().sort(byReleaseDateAsc);
            const wrap = document.createElement("div"); wrap.className = "grid";
            for (const g of list) {
                const card = document.createElement("div"); card.className = "card";
                const img = document.createElement("div"); img.className = "game-img";
                if (g.imageSlug) {
                    lazyBg(`images/games/${encodeURIComponent(g.imageSlug)}.webp`);
                } else {
                    img.style.backgroundImage = "none";
                }
                const title = document.createElement("div");
                title.innerHTML = `<strong>${safeHtml(g.title || "(Untitled)")}</strong>`;
                const meta = document.createElement("div");
                meta.className = "row muted";
                const date = g.releaseDate ? new Date(g.releaseDate).toISOString().slice(0, 10) : "—";
                meta.innerHTML = `<span class="pill">${safeHtml(g.console || "—")}</span><span class="pill">${safeHtml(date)}</span>`;
                card.appendChild(img); card.appendChild(title); card.appendChild(meta);
                wrap.appendChild(card);
            }
            mainEl.innerHTML = ""; mainEl.appendChild(wrap);
        }

        function renderSearch() {
            mainEl.innerHTML = "";
            const wrap = document.createElement("div"); wrap.className = "search-wrap";

            const bar = document.createElement("div"); bar.className = "search-bar";
            const input = document.createElement("input"); input.type = "text"; input.placeholder = "Search any field or Pokédex entry…";
            const btn = document.createElement("button"); btn.className = "btn primary"; btn.textContent = "Search";
            bar.appendChild(input); bar.appendChild(btn);

            const summary = document.createElement("div"); summary.className = "muted";
            summary.textContent = "Enter a word or phrase to begin.";
            const results = document.createElement("div"); results.className = "results";

            function doSearch() {
                const qRaw = input.value || ""; const q = qRaw.trim().toLowerCase();
                results.innerHTML = "";
                if (!q) { summary.textContent = "Enter a word or phrase to begin."; return; }

                // Build a quick lookup for game release dates/titles
                const gameById = Object.create(null);
                for (const g of DATA.games) { gameById[g.id] = g; }

                // Scan Pokémon
                const hits = [];
                for (const p of DATA.pokemon) {
                    let relevancy = 0;
                    const fieldMatches = [];

                    // Fields to search
                    const fields = {
                        id: p.id, name: p.name, category: p.category, form: p.form, species: p.species,
                        evolution: p.evolution, type1: p.type1, type2: p.type2
                    };
                    for (const [k, v] of Object.entries(fields)) {
                        const s = String(v || "");
                        if (s && s.toLowerCase().includes(q)) {
                            relevancy++;
                            fieldMatches.push({ label: k, value: s });
                        }
                    }

                    // Pokédex entries: collect matches; dedupe by entry text, keep OLDEST game
                    const pdx = p.pokedex || {};
                    const dexMatchesByText = new Map(); // text -> { gameId, entry }
                    for (const [gameId, obj] of Object.entries(pdx)) {
                        const entry = obj && obj.entry ? String(obj.entry) : "";
                        if (!entry) continue;
                        if (entry.toLowerCase().includes(q)) {
                            relevancy++;
                            const textKey = entry.trim().replace(/\s+/g, " "); // normalise
                            const g = gameById[gameId];
                            const dateMs = g && g.releaseDate ? Date.parse(g.releaseDate) : Number.POSITIVE_INFINITY;
                            if (!dexMatchesByText.has(textKey)) {
                                dexMatchesByText.set(textKey, { gameId, entry, dateMs });
                            } else {
                                // keep the oldest (smallest dateMs)
                                const cur = dexMatchesByText.get(textKey);
                                if (dateMs < cur.dateMs) {
                                    dexMatchesByText.set(textKey, { gameId, entry, dateMs });
                                }
                            }
                        }
                    }

                    if (relevancy > 0) {
                        hits.push({
                            p,
                            relevancy,
                            fieldMatches,
                            dexMatches: Array.from(dexMatchesByText.values()).sort((a, b) => a.dateMs - b.dateMs)
                        });
                    }
                }

                // Sort hits: relevancy desc, then by ID (numeric + suffix)
                hits.sort((A, B) => {
                    if (B.relevancy !== A.relevancy) return B.relevancy - A.relevancy;
                    return idComparator(A.p, B.p);
                });

                summary.textContent = `${hits.length} Pokémon matched for “${qRaw}”. Results sorted by relevancy, then ID.`;

                for (const h of hits) {
                    const { p, fieldMatches, dexMatches } = h;
                    const card = document.createElement("div"); card.className = "result";

                    const header = document.createElement("div"); header.className = "result-header";
                    const img = document.createElement("div"); img.className = "result-img";
                    lazyBg(`images/pkmn/${encodeURIComponent(p.id)}.webp`);
                    const title = document.createElement("div");
                    const form = p.form ? ` <span class="muted">• ${safeHtml(p.form)}</span>` : "";
                    title.innerHTML = `<strong>${safeHtml(p.name || "(Unnamed)")}</strong>${form}<div class="muted">#${safeHtml(p.id)} • ${safeHtml([p.type1, p.type2].filter(Boolean).join(" / ") || "—")}</div>`;
                    const score = document.createElement("div");
                    score.innerHTML = `<span class="pill">Relevancy: ${h.relevancy}</span>`;
                    header.appendChild(img); header.appendChild(title); header.appendChild(score);
                    card.appendChild(header);

                    if (fieldMatches.length) {
                        const fieldsBox = document.createElement("div");
                        fieldsBox.innerHTML = `<div class="section-title">Fields</div>`;
                        const list = document.createElement("div"); list.className = "fields";
                        for (const m of fieldMatches) {
                            const label = m.label.replace(/^./, c => c.toUpperCase());
                            const div = document.createElement("div");
                            div.innerHTML = `<span class="muted">${safeHtml(label)}:</span> ${safeHtml(m.value)}`;
                            list.appendChild(div);
                        }
                        fieldsBox.appendChild(list);
                        card.appendChild(fieldsBox);
                    }

                    if (dexMatches.length) {
                        const dexBox = document.createElement("div");
                        dexBox.innerHTML = `<div class="section-title">Pokédex entries (oldest unique matches)</div>`;
                        const list = document.createElement("div"); list.className = "dex";
                        for (const dm of dexMatches) {
                            const g = DATA.games.find(x => x.id === dm.gameId);
                            const gTitle = g ? g.title : dm.gameId;
                            const date = (g && g.releaseDate) ? new Date(g.releaseDate).toISOString().slice(0, 10) : "—";
                            const item = document.createElement("div"); item.className = "dex-entry";
                            item.innerHTML = `<div class="muted">${safeHtml(gTitle)} • ${safeHtml(date)}</div><div>${safeHtml(dm.entry)}</div>`;
                            list.appendChild(item);
                        }
                        dexBox.appendChild(list);
                        card.appendChild(dexBox);
                    }

                    results.appendChild(card);
                }
            }

            btn.addEventListener("click", doSearch);
            input.addEventListener("keydown", (e) => { if (e.key === "Enter") { doSearch(); } });

            wrap.appendChild(bar);
            wrap.appendChild(summary);
            wrap.appendChild(results);
            mainEl.appendChild(wrap);
        }

        /* =======================
           Admin Overlay Wiring
           (same UI, reusing utilities above)
           ======================= */
        const overlay = document.getElementById("overlay");
        const openAdmin = document.getElementById("openAdmin");
        const closeAdmin = document.getElementById("closeAdmin");
        const viewTabs = document.getElementById("viewTabs");
        const leftTitle = document.getElementById("leftTitle");
        const rightTitle = document.getElementById("rightTitle");
        const leftList = document.getElementById("leftList");
        const leftSearch = document.getElementById("leftSearch");
        const addBtn = document.getElementById("addBtn");
        const deleteBtn = document.getElementById("deleteBtn");
        const rightBody = document.getElementById("rightBody");
        const downloadBtn = document.getElementById("downloadBtn");
        const importBtn = document.getElementById("importBtn");
        const importInput = document.getElementById("importInput");
        const sortBtn = document.getElementById("sortBtn");

        openAdmin.addEventListener("click", () => { overlay.classList.add("open"); renderAdminView(); });
        closeAdmin.addEventListener("click", () => { overlay.classList.remove("open"); });

        downloadBtn.addEventListener("click", () => {
            const blob = new Blob([JSON.stringify(DATA, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a"); a.href = url; a.download = "data.json"; document.body.appendChild(a); a.click(); a.remove();
            URL.revokeObjectURL(url);
        });

        importBtn.addEventListener("click", () => importInput.click());
        importInput.addEventListener("change", async () => {
            const file = importInput.files?.[0]; if (!file) return;
            try {
                let text = await file.text(); let json;
                try { json = JSON.parse(text); } catch { text = fixJsonText(text); json = JSON.parse(text); }
                DATA = Array.isArray(json) ? normalizeData({ pokemon: json, games: [] }) : normalizeData(json);
                selectedId = null; updateDatasetSummary(); renderAdminView(); renderMain();
            } catch (e) { alert("Failed to import JSON: " + (e?.message || e)); }
            finally { importInput.value = ""; }
        });

        sortBtn.addEventListener("click", () => {
            if (adminActiveView === "pokemon") {
                pokemonSortMode = (pokemonSortMode === "AZ") ? "09" : "AZ";
                sortBtn.textContent = (pokemonSortMode === "AZ") ? "A–Z" : "0–9";
            } else {
                gameSortMode = (gameSortMode === "AZ") ? "DATE" : "AZ";
                sortBtn.textContent = (gameSortMode === "AZ") ? "A–Z" : "Date";
            }
            refreshLeftList();
        });

        viewTabs.addEventListener("click", (e) => {
            const seg = e.target.closest(".seg"); if (!seg) return;
            for (const s of viewTabs.querySelectorAll(".seg")) { s.classList.remove("active"); s.setAttribute("aria-selected", "false"); }
            seg.classList.add("active"); seg.setAttribute("aria-selected", "true");
            adminActiveView = seg.dataset.view; sortBtn.textContent = adminActiveView === "pokemon" ? (pokemonSortMode === "AZ" ? "A–Z" : "0–9") : (gameSortMode === "AZ" ? "A–Z" : "Date");
            selectedId = null; leftFilter = ""; leftSearch.value = ""; renderAdminView();
        });

        leftSearch.addEventListener("input", () => { leftFilter = leftSearch.value.trim().toLowerCase(); refreshLeftList(); });
        addBtn.addEventListener("click", () => {
            if (adminActiveView === "pokemon") {
                const p = { id: "", name: "", form: "", species: "", evolution: "", type1: "", type2: "", hp: null, attack: null, defense: null, spAtk: null, spDef: null, speed: null, pokedex: {} };
                p._tempId = crypto.randomUUID(); DATA.pokemon.push(p); selectedId = p._tempId;
            } else {
                const g = { id: crypto.randomUUID(), title: "New Game", releaseDate: "", console: "", colorHex: "#888888", imageSlug: "" };
                DATA.games.push(g); selectedId = g.id;
            }
            updateDatasetSummary(); renderAdminView(); renderMain();
        });

        deleteBtn.addEventListener("click", () => {
            if (!confirm("Delete this item? This cannot be undone.")) return;
            if (adminActiveView === "pokemon") {
                const idx = DATA.pokemon.findIndex(p => (p.id || p._tempId) === selectedId);
                if (idx >= 0) DATA.pokemon.splice(idx, 1);
            } else {
                const idx = DATA.games.findIndex(g => g.id === selectedId);
                if (idx >= 0) DATA.games.splice(idx, 1);
            }
            selectedId = null; updateDatasetSummary(); renderAdminView(); renderMain();
        });

        function renderAdminView() {
            leftTitle.textContent = adminActiveView === "pokemon" ? "Pokemon" : "Games";
            rightTitle.textContent = "No item selected";
            deleteBtn.style.display = selectedId ? "inline-block" : "none";

            // Default Pokemon left-column order to 0–9 on first open
            if (adminActiveView === "pokemon" && pokemonSortMode !== "09") {
                pokemonSortMode = "09";
            }

            // Update sort button label to match current view & mode
            sortBtn.textContent = (adminActiveView === "pokemon")
                ? (pokemonSortMode === "AZ" ? "A–Z" : "0–9")
                : (gameSortMode === "AZ" ? "A–Z" : "Date");

                refreshLeftList();
            renderAdminRight();
        }

        function renderAdminLeftList() {
            const list = document.getElementById("leftList");
            list.innerHTML = "";
            let source;

            if (adminActiveView === "pokemon") {
                source = DATA.pokemon.slice();
                // Respect current mode (default is 0–9)
                if (pokemonSortMode === "AZ") {
                    source.sort((a, b) => (a.name || "").localeCompare((b.name || ""), undefined, { sensitivity: "base" }));
                } else {
                    source.sort(idComparator);
                }
            } else {
                source = DATA.games.slice();
                if (gameSortMode === "AZ") {
                    source.sort((a, b) => (a.title || "").localeCompare((b.title || ""), undefined, { sensitivity: "base" }));
                } else {
                    source.sort(byReleaseDateAsc);
                }
            }

            const filtered = source.filter(item => {
                const key = (adminActiveView === "pokemon"
                    // include form in the searchable string
                    ? `${item.name} ${item.form || ""} ${item.id} ${item.species}`.toLowerCase()
                    : `${item.title} ${item.console} ${item.releaseDate}`.toLowerCase()
                );
                return key.includes(leftFilter);
            });

            for (const item of filtered) {
                const itemId = adminActiveView === "pokemon" ? (item.id || item._tempId) : item.id;

                const div = document.createElement("div");
                div.className = "list-item" + (itemId === selectedId ? " active" : "");
                div.setAttribute("role", "option");

                // Thumb (small image on the left)
                const thumb = document.createElement("div");
                thumb.classList.add("list_thumb");

                if (adminActiveView === "pokemon") {
                const id = (item.id || "").trim();
                if (id) lazyBg(thumb, `images/pkmn/${encodeURIComponent(id)}.webp`);
                } else {
                const slug = (item.imageSlug || "").trim();
                if (slug) lazyBg(thumb, `images/games/${encodeURIComponent(slug)}.webp`);
                }


                const left = document.createElement("div");
                left.style.display = "grid";
                left.style.alignItems = "center";
                left.style.gridTemplateColumns = "auto 1fr";
                left.style.columnGap = "8px";

                left.appendChild(thumb);

                const titleWrap = document.createElement("div");
                // Name (bold)
                const titleSpan = document.createElement("div");
                titleSpan.innerHTML = adminActiveView === "pokemon"
                    ? `<strong>${safeHtml(item.name || "(new Pokémon)")}</strong>`
                    : `<strong>${safeHtml(item.title || "(untitled)")}</strong>`;
                titleWrap.appendChild(titleSpan);

                // Form (muted, smaller, on its own line) — only for Pokémon and only if present
                if (adminActiveView === "pokemon" && item.form) {
                    const formLine = document.createElement("div");
                    formLine.className = "muted";
                    formLine.style.fontSize = "12px";
                    formLine.style.lineHeight = "1.2";
                    formLine.style.marginTop = "2px";
                    formLine.textContent = item.form;
                    titleWrap.appendChild(formLine);
                }

                left.appendChild(titleWrap);

                const right = document.createElement("div");
                right.className = "muted";
                right.textContent = adminActiveView === "pokemon" ? (item.id || "") : (item.releaseDate || "");

                div.appendChild(left);
                div.appendChild(right);
                div.addEventListener("click", () => { selectedId = itemId; renderAdminRight(); });
                list.appendChild(div);
            }
        }

        function makeField(label, type, value, onChange, opts = {}) {
            const container = document.createElement("div"); container.className = "field";
            const lab = document.createElement("label"); lab.textContent = label; container.appendChild(lab);
            let input;
            if (type === "select") {
                input = document.createElement("select");
                for (const opt of (opts.options || [])) {
                    const o = document.createElement("option"); o.value = opt; o.textContent = opt || "—"; if (String(value) === String(opt)) o.selected = true;
                    input.appendChild(o);
                }
            } else if (type === "textarea") {
                input = document.createElement("textarea"); input.value = value || "";
            } else {
                input = document.createElement("input"); input.type = type; if (value !== null && value !== undefined) input.value = String(value);
            }
            input.addEventListener("input", () => onChange(type === "number" ? numOrNullFromInput(input.value) : input.value));
            container.appendChild(input);
            return { container, input };
        }

        function renderAdminRight() {
            const body = document.getElementById("rightBody");
            body.innerHTML = "";
            deleteBtn.style.display = selectedId ? "inline-block" : "none";
            if (!selectedId) {
                rightTitle.textContent = "No item selected";
                body.innerHTML = `<div class="muted">Select or add an item to edit its details.</div>`;
                return;
            }

            if (adminActiveView === "pokemon") {
                const p = DATA.pokemon.find(x => (x.id || x._tempId) === selectedId);
                if (!p) return;

                rightTitle.textContent = p.name || "(new Pokémon)";

                // ============ BASIC INFO ============ //
                const basic = document.createElement("div");
                basic.className = "subsection";
                basic.innerHTML = `<h4>Basic Info</h4>`;
                const basicGrid = document.createElement("div");
                basicGrid.className = "field-grid";

                // Image preview
                const prevBox = document.createElement("div");
                prevBox.className = "field";
                const prevLabel = document.createElement("label");
                prevLabel.textContent = "Image Preview (images/pkmn/ID.webp — case sensitive)";
                const prev = document.createElement("div");
                prev.className = "img-preview";
                prevBox.appendChild(prevLabel);
                prevBox.appendChild(prev);
                basicGrid.appendChild(prevBox);

                function updateGamePrev() {
  const slug = (g.imageSlug || "").trim();
  const url = slug ? `images/games/${encodeURIComponent(slug)}.webp` : "";
  if (!url) { gPrev.style.backgroundImage = "none"; return; }
  loadBgOnce(url, () => applyBg(gPrev, url), () => { gPrev.style.backgroundImage = "none"; });
}

                // ID
                basicGrid.appendChild(
                    makeField("ID", "text", p.id ?? "", (val) => {
                        p.id = val;
                        refreshLeftList();
                        updatePrev();
                    }).container
                );

                // Name
                basicGrid.appendChild(
                    makeField("Name", "text", p.name ?? "", (val) => {
                        p.name = val;
                        rightTitle.textContent = p.name || "(new Pokémon)";
                        refreshLeftList();
                    }).container
                );

                // Form
                basicGrid.appendChild(
                    makeField("Form", "text", p.form ?? "", (val) => {
                        p.form = val;
                        refreshLeftList();
                    }).container
                );

                basic.appendChild(basicGrid);

                // ============ SECONDARY INFO ============ //
                const secondary = document.createElement("div");
                secondary.className = "subsection";
                secondary.innerHTML = `<h4>Secondary Info</h4>`;
                const secondaryGrid = document.createElement("div");
                secondaryGrid.className = "field-grid";

                // Type 1 / Type 2
                secondaryGrid.appendChild(
                    makeField("Type 1", "select", p.type1 ?? "", (val) => { p.type1 = val; }, { options: TYPE_OPTIONS }).container
                );
                secondaryGrid.appendChild(
                    makeField("Type 2", "select", p.type2 ?? "", (val) => { p.type2 = val; }, { options: TYPE_OPTIONS }).container
                );

                // Evolution
                secondaryGrid.appendChild(
                    makeField("Evolution", "text", p.evolution ?? "", (val) => { p.evolution = val; }).container
                );

                // Species
                secondaryGrid.appendChild(
                    makeField("Species", "text", p.species ?? "", (val) => { p.species = val; }).container
                );

                secondary.appendChild(secondaryGrid);

                // ============ STATS ============ //
                const stats = document.createElement("div");
                stats.className = "subsection";
                stats.innerHTML = `<h4>Stats</h4>`;
                const statsGrid = document.createElement("div");
                statsGrid.className = "field-grid";

                statsGrid.appendChild(makeField("HP", "number", (p.hp ?? ""), (val) => { p.hp = val; }).container);
                statsGrid.appendChild(makeField("Attack", "number", (p.attack ?? ""), (val) => { p.attack = val; }).container);
                statsGrid.appendChild(makeField("Defence", "number", (p.defense ?? ""), (val) => { p.defense = val; }).container);
                statsGrid.appendChild(makeField("Sp. Attack", "number", (p.spAtk ?? ""), (val) => { p.spAtk = val; }).container);
                statsGrid.appendChild(makeField("Sp. Defence", "number", (p.spDef ?? ""), (val) => { p.spDef = val; }).container);
                statsGrid.appendChild(makeField("Speed", "number", (p.speed ?? ""), (val) => { p.speed = val; }).container);

                stats.appendChild(statsGrid);

                // ============ APPEND GROUPS TO RIGHT PANEL ============ //
                const body = document.getElementById("rightBody");
                body.innerHTML = "";
                body.appendChild(basic);
                body.appendChild(secondary);
                body.appendChild(stats);

                // ============ POKÉDEX ENTRIES (unchanged) ============ //
                const pdx = document.createElement("div");
                pdx.className = "subsection";
                pdx.innerHTML = `<h4>Pokédex Entries (linked to Games)</h4><div class="muted">Add a Game to see inputs here.</div>`;
                const grid = document.createElement("div");
                grid.className = "pokedex-grid";

                const sortedGames = DATA.games.slice().sort(byReleaseDateAsc);
                if (sortedGames.length === 0) {
                    const empty = document.createElement("div");
                    empty.className = "muted";
                    empty.textContent = "No games defined yet.";
                    grid.appendChild(empty);
                } else {
                    for (const g of sortedGames) {
                        const card = document.createElement("div");
                        card.className = "pokedex-card";
                        const gameColor = g.colorHex && /^#[0-9a-f]{6}$/i.test(g.colorHex) ? g.colorHex.toUpperCase() : "#888888";
                        card.setAttribute("style", `--dex_color:${gameColor}`);
                        const title = document.createElement("div");
                        // show bullets only for present parts
                        const parts = [];
                        if (g.releaseDate) parts.push(safeHtml(g.releaseDate));
                        if (g.console) parts.push(safeHtml(g.console));
                        title.innerHTML = `<strong>${safeHtml(g.title || "(untitled)")}</strong> <span class="muted">${parts.length ? "• " + parts.join(" • ") : ""}</span>`;
                        card.appendChild(title);

                        const fwrap = document.createElement("div");
                        fwrap.className = "field-grid";

                        const pd = (p.pokedex[g.id] ||= { regionalDexNumber: "", entry: "" });

                        fwrap.appendChild(
                            makeField("Regional Dex Number", "text", pd.regionalDexNumber, (val) => { pd.regionalDexNumber = val; }).container
                        );
                        fwrap.appendChild(
                            makeField("Pokédex Entry", "textarea", pd.entry, (val) => { pd.entry = val; }).container
                        );

                        card.appendChild(fwrap);
                        grid.appendChild(card);
                    }
                }
                pdx.appendChild(grid);
                body.appendChild(pdx);

                // kick off preview
                updatePrev();


            } else {
                const g = DATA.games.find(x => x.id === selectedId); if (!g) return;
                rightTitle.textContent = g.title || "(untitled game)";
                const wrap = document.createElement("div"); wrap.className = "field-grid";

                // Title / Release / Console
                wrap.appendChild(makeField("Title", "text", g.title, (val) => { g.title = val; rightTitle.textContent = g.title || "(untitled game)"; refreshLeftList(); }).container);
                wrap.appendChild(makeField("Release Date", "date", g.releaseDate, (val) => { g.releaseDate = val; refreshLeftList(); }).container);
                wrap.appendChild(makeField("Console", "text", g.console, (val) => { g.console = val; }).container);

                // === Theme Colour: synced picker + hex input ===
                (function () {
                    const field = document.createElement("div"); field.className = "field";
                    const lab = document.createElement("label"); lab.textContent = "Theme Colour (picker + hex)";
                    const row = document.createElement("div"); row.className = "row";

                    // colour picker
                    const pick = document.createElement("input");
                    pick.type = "color";
                    pick.value = /^#[0-9a-fA-F]{6}$/.test(g.colorHex || "") ? g.colorHex : "#888888";
                    pick.style.width = "44px";
                    pick.style.height = "36px";
                    pick.style.border = "1px solid var(--border)";
                    pick.style.borderRadius = "8px";
                    pick.style.background = "transparent";
                    pick.style.padding = "0";

                    // hex textbox
                    const hex = document.createElement("input");
                    hex.type = "text";
                    hex.value = g.colorHex || "#888888";
                    hex.placeholder = "#RRGGBB";
                    hex.style.flex = "1";
                    hex.style.marginLeft = "10px";
                    hex.style.borderRadius = "10px";
                    hex.addEventListener("input", () => {
                        const v = hex.value.trim();
                        const norm = normalizeHex(v);
                        if (norm) {
                            g.colorHex = norm;
                            pick.value = norm;
                            hex.style.borderColor = "var(--border)";
                            refreshLeftList();
                        } else {
                            // visual hint if invalid
                            hex.style.borderColor = "var(--danger)";
                        }
                    });

                    pick.addEventListener("input", () => {
                        const v = pick.value;
                        g.colorHex = v;
                        hex.value = v.toUpperCase();
                        hex.style.borderColor = "var(--border)";
                        refreshLeftList();
                    });

                    row.appendChild(pick);
                    row.appendChild(hex);
                    field.appendChild(lab);
                    field.appendChild(row);
                    wrap.appendChild(field);

                    function normalizeHex(v) {
                        // Accept formats: #RRGGBB or RRGGBB (case-insensitive)
                        if (/^#[0-9a-fA-F]{6}$/.test(v)) return v.toUpperCase();
                        if (/^[0-9a-fA-F]{6}$/.test(v)) return ("#" + v).toUpperCase();
                        return null;
                    }
                })();

                // === Image slug + preview (preview LEFT of field) ===
                const slugField = makeField("Image Slug (images/games/slug.webp)", "text", g.imageSlug, (val) => { g.imageSlug = val; updateGamePrev(); refreshLeftList(); });
                const slugRow = document.createElement("div");
                slugRow.className = "row";
                const gPrev = document.createElement("div");
                gPrev.className = "img-preview";
                gPrev.style.width = "140px";
                gPrev.style.height = "78px";
                gPrev.style.marginRight = "12px";
                const fieldWrap = document.createElement("div");
                fieldWrap.style.flex = "1";
                fieldWrap.appendChild(slugField.container);
                slugRow.appendChild(gPrev);
                slugRow.appendChild(fieldWrap);
                wrap.appendChild(slugRow);

                function updateGamePrev() {
                    const slug = (g.imageSlug || "").trim();
                    const url = slug ? `images/games/${encodeURIComponent(slug)}.webp` : "";
                    lazyBg(url, gPrev);
                }

                body.appendChild(wrap);
                updateGamePrev();
            }
        }

        // Kick off
        loadInitialData();
    </script>
</body>

</html>